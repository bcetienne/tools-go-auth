image: golang:1.24

stages:
  - prepare
  - quality
  - build

variables:
  # Global cache and optimizations
  GOCACHE: "$CI_PROJECT_DIR/.cache/go-build"
  GOMODCACHE: "$CI_PROJECT_DIR/.cache/go-mod"
  CGO_ENABLED: "0"
  GOPROXY: "https://proxy.golang.org,direct"

# Reusable cache template
.go-cache:
  cache:
    key:
      files:
        - go.sum
    paths:
      - .cache/go-build
      - .cache/go-mod
    policy: pull

# Prepare dependencies job
📦 Prepare Dependencies:
  stage: prepare
  script:
    - go mod download
    - go mod verify
    # Pre-install tools to cache them
    - go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.59.1
    - go install golang.org/x/vuln/cmd/govulncheck@latest
  cache:
    key:
      files:
        - go.sum
    paths:
      - .cache/go-build
      - .cache/go-mod
    policy: pull-push

# Parallel jobs for quality
💅 Lint:
  stage: quality
  extends: .go-cache
  needs: ["📦 Prepare Dependencies"]
  script:
    # Use cached binaries
    - export PATH="$GOPATH/bin:$PATH"
    # Linter with optimized configuration
    - |
      golangci-lint run -v \
        --timeout 5m \
        --skip-files "tests/.*" \
        --disable typecheck \
        --concurrency 4 \
        --max-same-issues 0 \
        --max-issues-per-linter 0 || true
    # Check for real errors
    - |
      OUTPUT=$(golangci-lint run --timeout 5m --disable typecheck 2>&1 || true)
      if echo "$OUTPUT" | grep -v "typecheck" | grep -E "\.go:[0-9]+:[0-9]+:"; then
        echo "Found real linting errors (not typecheck):"
        echo "$OUTPUT" | grep -v "typecheck"
        exit 1
      fi

🗄️ SQL Validation:
  stage: quality
  extends: .go-cache
  needs: ["📦 Prepare Dependencies"]
  before_script:
    # Quick installation of postgresql-client
    - apt-get update -qq && apt-get install -y -qq postgresql-client > /dev/null
  script:
    - |
      echo "=== Analyzing SQL queries ==="
      
      # Optimized search for SQL files
      SQL_FILES=$(find . -name "*.go" -not -path "./vendor/*" -not -path "./tests/*" -type f -print0 | \
                  xargs -0 grep -l "SELECT\|INSERT\|UPDATE\|DELETE\|CREATE\|DROP\|ALTER" 2>/dev/null || true)
      
      if [ -z "$SQL_FILES" ]; then
        echo "No SQL queries found"
        exit 0
      fi
      
      # Parallel analysis of files
      echo "$SQL_FILES" | xargs -P 4 -I {} sh -c '
        echo "--- Analyzing {} ---"
        grep -n -E "(SELECT|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER)" "{}" | head -20
      '
      
      # Security checks in a single pass
      echo "=== Security checks ==="
      find . -name "*.go" -not -path "./vendor/*" -type f -print0 | \
        xargs -0 grep -n -E "(fmt\.Sprintf.*(SELECT|INSERT|UPDATE|DELETE)|\+ .*(SELECT|INSERT|UPDATE|DELETE))" || \
        echo "✓ No SQL injection vulnerabilities found"
      
      # Check for parameterized queries
      find . -name "*.go" -not -path "./vendor/*" -type f -print0 | \
        xargs -0 grep -E "(db\.Exec|db\.Query)" | grep -v "\$" || \
        echo "✓ All queries appear to be parameterized"
  allow_failure: true

🧪 Tests:
  stage: quality
  extends: .go-cache
  needs: ["📦 Prepare Dependencies"]
  services:
    - name: docker:dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    # Tests with parallelization
    - go test -p 4 -race -short ./tests/...

📊 Coverage:
  stage: quality
  extends: .go-cache
  needs: ["📦 Prepare Dependencies"]
  services:
    - name: docker:dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    # Coverage with parallel tests
    - go test -p 4 -race -coverprofile=coverage.out -coverpkg=./auth/...,./lib/...,./model/...,./validation/... ./tests/...
    # Use awk to avoid installing bc
    - |
      COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
      echo "Total coverage: $COVERAGE%"
      awk -v cov="$COVERAGE" 'BEGIN { if (cov < 80.0) exit 1 }'
  coverage: '/^Total coverage: (\d+\.\d+)%$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out

🛡️ Security:
  stage: quality
  extends: .go-cache
  needs: ["📦 Prepare Dependencies"]
  script:
    - export PATH="$GOPATH/bin:$PATH"
    # Vulnerability scan with cache
    - govulncheck -scan package ./...

📦 Build:
  stage: build
  extends: .go-cache
  needs:
    - "💅 Lint"
    - "🧪 Tests"
    - "📊 Coverage"
    - "🛡️ Security"
  script:
    # Optimized build with parallelization
    - go build -p 4 -v -ldflags="-s -w" ./...
  artifacts:
    paths:
      - bin/
    expire_in: 1 week
